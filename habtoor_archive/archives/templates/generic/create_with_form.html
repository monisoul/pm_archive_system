{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}
    اضافة {{ model_name_singular }}
{% endblock %}

{% block content %}
<div class="main_dashboard">
    <div class="container mt-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="page-title mb-0">
                إضافة {{ model_name_singular }}
            </h1>
            <a href="{% url model_name|add:'-list' %}" class="btn btn-secondary">
                &larr; العودة للقائمة
            </a>
        </div>

        <div class="card p-4">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- المعلومات الأساسية -->
                <h3 class="mb-3 text-primary">المعلومات الاساسية</h3>

                <div class="row">
                    {{ form.as_p }}
                </div>

                <hr class="my-5">

                <!-- المرفقات -->
                {% if attachment_formset %}
                    <h3 class="mb-3 text-info">
                        مرفقات {{ model_name_singular }}
                    </h3>

                    <div class="alert alert-info">
                        يمكنك إضافة مرفقات هنا. إذا لم تقم بإضافة ملف، سيتم تجاهل هذا الجزء عند الحفظ.
                    </div>

                    {{ attachment_formset.management_form }}

                    <table class="table table-bordered table-sm table-striped">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Is URL?</th>
                                <th>Shareable?</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody id="attachment-form-container">
                            {% for attachment_form in attachment_formset %}
                                <tr class="attachment-form-row">
                                    <td>
                                        {{ attachment_form.file }}

                                        {% if attachment_form.instance.pk %}
                                            <p class="text-muted small mt-1">
                                                Current File:
                                                <a href="{{ attachment_form.instance.file.url }}" target="_blank">
                                                    {{ attachment_form.instance.file.name|default:"File Link" }}
                                                </a>
                                            </p>
                                        {% endif %}

                                        {% if attachment_form.file.errors %}
                                            <div class="text-danger small">
                                                {{ attachment_form.file.errors }}
                                            </div>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {{ attachment_form.is_url }}
                                    </td>

                                    <td>
                                        {{ attachment_form.can_be_shared }}
                                    </td>

                                    <td>
                                        {{ attachment_form.DELETE }}
                                        {% if attachment_form.non_field_errors %}
                                            <div class="text-danger small">
                                                {{ attachment_form.non_field_errors }}
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}

                <!-- أماكن النشر -->
                {% if publication_formset %}
                    <hr class="my-5">

                    <h3 class="mb-3 text-warning">أماكن النشر</h3>

                    <div class="alert alert-warning">
                        يمكنك إضافة مكان أو أكثر لنشر {{ model_name_singular }}
                        (يوتيوب، موقع، صحيفة، كتاب...).
                    </div>

                    {{ publication_formset.management_form }}

                    <table class="table table-bordered table-sm table-striped">
                        <thead>
                            <tr>
                                <th>منصة النشر</th>
                                <th>تاريخ النشر</th>
                                <th>بيانات إضافية</th>
                                <th>ملاحظات</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pub_form in publication_formset %}
                                <tr>
                                    <td>
                                        {{ pub_form.platform }}
                                        {% if pub_form.platform.errors %}
                                            <div class="text-danger small">
                                                {{ pub_form.platform.errors }}
                                            </div>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {{ pub_form.publish_date }}
                                    </td>

                                    <td>
                                        <table class="table table-borderless mb-0 p-0">
                                            <tbody>
                                                {% for field in pub_form %}
                                                    {% if field.name not in "platform publish_date notes DELETE id" %}
                                                    <tr>
                                                        <td style="padding: 0 8px 4px 0; font-weight: 600; white-space: nowrap;">
                                                            {{ field.label }}:
                                                        </td>
                                                        <td style="padding: 0 0 4px 0;">
                                                            {{ field }}
                                                            {% if field.errors %}
                                                                <div class="text-danger small">
                                                                    {{ field.errors }}
                                                                </div>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </td>

                                    <td>
                                        {{ pub_form.notes }}
                                    </td>

                                    <td>
                                        {{ pub_form.DELETE }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}

                <!-- أزرار الحفظ -->
                <div class="d-flex justify-content-start gap-2 mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        حفظ
                    </button>
                    <a href="{% url model_name|add:'-list' %}" class="btn btn-secondary btn-lg">
                        الغاء
                    </a>
                </div>

            </form>
        </div>
    </div>
</div>

<style>
.page-title {
    font-size: 2rem;
    font-weight: 700;
    color: #0d6efd;
    border-bottom: 3px solid #0d6efd;
    padding-bottom: 0.3rem;
}

.card {
    border-radius: 10px;
    background-color: #ffffff;
}

form p {
    margin-bottom: 1rem;
}

.btn-primary,
.btn-outline-secondary {
    min-width: 130px;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.messages .alert {
    font-size: 0.95rem;
}

.card:hover {
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease-in-out;
}

@media (max-width: 768px) {
    .page-title {
        font-size: 1.5rem;
    }
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
    }
}
</style>
{% endblock %}
